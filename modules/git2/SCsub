#!/usr/bin/env python

Import('env')
Import('env_modules')

env_git2 = env_modules.Clone()

# Thirdparty source files
if env['builtin_libgit2']:
    thirdparty_dir = "#thirdparty/libgit2/"

    git2_sources = [
        # libgit2 dependencies
        "deps/http-parser/http_parser.c",
        "deps/regex/regex.c",
        "deps/zlib/adler32.c",
        "deps/zlib/crc32.c",
        "deps/zlib/deflate.c",
        "deps/zlib/infback.c",
        "deps/zlib/inffast.c",
        "deps/zlib/inflate.c",
        "deps/zlib/inftrees.c",
        "deps/zlib/trees.c",
        "deps/zlib/zutil.c",

        # libgit2 source
        "src/alloc.c",
        "src/annotated_commit.c",
        "src/apply.c",
        "src/attr.c",
        "src/attrcache.c",
        "src/attr_file.c",
        "src/blame.c",
        "src/blame_git.c",
        "src/blob.c",
        "src/branch.c",
        "src/buffer.c",
        "src/buf_text.c",
        "src/cache.c",
        "src/checkout.c",
        "src/cherrypick.c",
        "src/clone.c",
        "src/commit.c",
        "src/commit_list.c",
        "src/config.c",
        "src/config_cache.c",
        "src/config_entries.c",
        "src/config_file.c",
        "src/config_mem.c",
        "src/config_parse.c",
        "src/crlf.c",
        "src/date.c",
        "src/delta.c",
        "src/describe.c",
        "src/diff.c",
        "src/diff_driver.c",
        "src/diff_file.c",
        "src/diff_generate.c",
        "src/diff_parse.c",
        "src/diff_print.c",
        "src/diff_stats.c",
        "src/diff_tform.c",
        "src/diff_xdiff.c",
        "src/errors.c",
        "src/fetch.c",
        "src/fetchhead.c",
        "src/filebuf.c",
        "src/fileops.c",
        "src/filter.c",
        "src/fnmatch.c",
        "src/global.c",
        "src/graph.c",
        "src/hash.c",
        "src/hashsig.c",
        "src/ident.c",
        "src/idxmap.c",
        "src/ignore.c",
        "src/index.c",
        "src/indexer.c",
        "src/iterator.c",
        "src/mailmap.c",
        "src/merge.c",
        "src/merge_driver.c",
        "src/merge_file.c",
        "src/message.c",
        "src/mwindow.c",
        "src/netops.c",
        "src/notes.c",
        "src/object.c",
        "src/object_api.c",
        "src/odb.c",
        "src/odb_loose.c",
        "src/odb_mempack.c",
        "src/odb_pack.c",
        "src/offmap.c",
        "src/oid.c",
        "src/oidarray.c",
        "src/oidmap.c",
        "src/pack-objects.c",
        "src/pack.c",
        "src/parse.c",
        "src/patch.c",
        "src/patch_generate.c",
        "src/patch_parse.c",
        "src/path.c",
        "src/pathspec.c",
        "src/pool.c",
        "src/posix.c",
        "src/pqueue.c",
        "src/proxy.c",
        "src/push.c",
        "src/reader.c",
        "src/rebase.c",
        "src/refdb.c",
        "src/refdb_fs.c",
        "src/reflog.c",
        "src/refs.c",
        "src/refspec.c",
        "src/remote.c",
        "src/repository.c",
        "src/reset.c",
        "src/revert.c",
        "src/revparse.c",
        "src/revwalk.c",
        "src/settings.c",
        "src/sha1_lookup.c",
        "src/signature.c",
        "src/sortedcache.c",
        "src/stash.c",
        "src/status.c",
        "src/stdalloc.c",
        "src/strmap.c",
        "src/submodule.c",
        "src/sysdir.c",
        "src/tag.c",
        "src/thread-utils.c",
        "src/trace.c",
        "src/trailer.c",
        "src/transaction.c",
        "src/transport.c",
        "src/tree-cache.c",
        "src/tree.c",
        "src/tsort.c",
        "src/util.c",
        "src/varint.c",
        "src/vector.c",
        "src/worktree.c",
        "src/zstream.c",
        "src/hash/hash_generic.c",
        "src/streams/mbedtls.c",
        "src/streams/openssl.c",
        "src/streams/registry.c",
        "src/streams/socket.c",
        "src/streams/stransport.c",
        "src/streams/tls.c",
        "src/transports/auth.c",
        "src/transports/auth_negotiate.c",
        "src/transports/cred.c",
        "src/transports/cred_helpers.c",
        "src/transports/git.c",
        "src/transports/http.c",
        "src/transports/local.c",
        "src/transports/smart.c",
        "src/transports/smart_pkt.c",
        "src/transports/smart_protocol.c",
        "src/transports/ssh.c",
        "src/transports/winhttp.c",
        "src/unix/map.c",
        "src/unix/realpath.c",
        "src/win32/dir.c",
        "src/win32/error.c",
        "src/win32/findfile.c",
        "src/win32/map.c",
        "src/win32/path_w32.c",
        "src/win32/posix_w32.c",
        "src/win32/precompiled.c",
        "src/win32/thread.c",
        "src/win32/utf-conv.c",
        "src/win32/w32_buffer.c",
        "src/win32/w32_crtdbg_stacktrace.c",
        "src/win32/w32_stack.c",
        "src/win32/w32_util.c",
        "src/xdiff/xdiffi.c",
        "src/xdiff/xemit.c",
        "src/xdiff/xhistogram.c",
        "src/xdiff/xmerge.c",
        "src/xdiff/xpatience.c",
        "src/xdiff/xprepare.c",
        "src/xdiff/xutils.c"
    ]

    git2_sources = [
        "deps/zlib/trees.c",
        "deps/zlib/crc32.c",
        "deps/zlib/inflate.c",
        "deps/zlib/inffast.c",
        "deps/zlib/zutil.c",
        "deps/zlib/deflate.c",
        "deps/zlib/inftrees.c",
        "deps/zlib/adler32.c",
        "deps/zlib/infback.c",
        "deps/http-parser/http_parser.c",
        "deps/regex/regex.c",
        # "deps/regex/regcomp.c"
        "src/thread-utils.c",
        "src/config_entries.c",
        "src/commit_list.c",
        "src/config_mem.c",
        "src/strmap.c",
        "src/ignore.c",
        "src/branch.c",
        "src/date.c",
        "src/status.c",
        "src/transaction.c",
        "src/config_file.c",
        "src/revparse.c",
        "src/proxy.c",
        "src/buf_text.c",
        "src/transport.c",
        "src/netops.c",
        "src/object_api.c",
        "src/vector.c",
        "src/pack.c",
        "src/attr_file.c",
        "src/graph.c",
        "src/annotated_commit.c",
        "src/mwindow.c",
        "src/revwalk.c",
        "src/tsort.c",
        "src/diff_file.c",
        "src/settings.c",
        "src/config_parse.c",
        "src/buffer.c",
        "src/pathspec.c",
        "src/refdb.c",
        "src/reader.c",
        "src/indexer.c",
        "src/worktree.c",
        "src/patch_parse.c",
        "src/blame.c",
        "src/notes.c",
        "src/signature.c",
        "src/util.c",
        "src/stdalloc.c",
        "src/attrcache.c",
        "src/tree-cache.c",
        "src/trailer.c",
        "src/object.c",
        "src/global.c",
        "src/iterator.c",
        "src/clone.c",
        "src/fetchhead.c",
        "src/transports/ssh.c",
        "src/transports/winhttp.c",
        "src/transports/http.c",
        "src/transports/smart_pkt.c",
        "src/transports/cred.c",
        "src/transports/smart_protocol.c",
        "src/transports/smart.c",
        "src/transports/auth.c",
        "src/transports/auth_negotiate.c",
        "src/transports/local.c",
        "src/transports/cred_helpers.c",
        "src/transports/git.c",
        "src/merge_driver.c",
        "src/blob.c",
        "src/commit.c",
        "src/varint.c",
        "src/pqueue.c",
        "src/describe.c",
        "src/delta.c",
        "src/odb_mempack.c",
        "src/cherrypick.c",
        "src/apply.c",
        "src/cache.c",
        "src/rebase.c",
        "src/sysdir.c",
        "src/parse.c",
        "src/alloc.c",
        "src/merge.c",
        "src/reflog.c",
        "src/path.c",
        "src/patch.c",
        "src/errors.c",
        "src/diff_parse.c",
        "src/fnmatch.c",
        "src/push.c",
        "src/oid.c",
        "src/revert.c",
        "src/pool.c",
        "src/offmap.c",
        "src/blame_git.c",
        "src/diff_generate.c",
        "src/merge_file.c",
        "src/odb_loose.c",
        "src/refspec.c",
        # "src/win32/findfile.c",
        # "src/win32/map.c",
        # "src/win32/w32_buffer.c",
        # "src/win32/w32_stack.c",
        # "src/win32/posix_w32.c",
        # "src/win32/w32_util.c",
        # "src/win32/thread.c",
        # "src/win32/error.c",
        # "src/win32/precompiled.c",
        # "src/win32/path_w32.c",
        # "src/win32/dir.c",
        # "src/win32/w32_crtdbg_stacktrace.c",
        # "src/win32/utf-conv.c",
        "src/config_cache.c",
        "src/tree.c",
        "src/diff.c",
        "src/odb.c",
        "src/reset.c",
        "src/zstream.c",
        "src/filebuf.c",
        "src/ident.c",
        "src/oidarray.c",
        "src/posix.c",
        "src/sha1_lookup.c",
        "src/message.c",
        "src/stash.c",
        "src/remote.c",
        "src/fileops.c",
        "src/sortedcache.c",
        "src/idxmap.c",
        "src/diff_xdiff.c",
        "src/streams/stransport.c",
        "src/streams/tls.c",
        "src/streams/socket.c",
        "src/streams/registry.c",
        "src/streams/mbedtls.c",
        "src/streams/openssl.c",
        "src/repository.c",
        "src/diff_driver.c",
        "src/tag.c",
        "src/pack-objects.c",
        "src/unix/map.c",
        "src/unix/realpath.c",
        "src/filter.c",
        "src/fetch.c",
        "src/mailmap.c",
        "src/config.c",
        "src/checkout.c",
        "src/diff_tform.c",
        "src/diff_stats.c",
        "src/index.c",
        "src/crlf.c",
        "src/hashsig.c",
        "src/hash.c",
        "src/odb_pack.c",
        "src/submodule.c",
        "src/xdiff/xutils.c",
        "src/xdiff/xemit.c",
        "src/xdiff/xdiffi.c",
        "src/xdiff/xhistogram.c",
        "src/xdiff/xpatience.c",
        "src/xdiff/xprepare.c",
        "src/xdiff/xmerge.c",
        "src/patch_generate.c",
        "src/trace.c",
        # "src/hash/hash_win32.c",
        "src/hash/hash_generic.c",
        # "src/hash/hash_mbedtls.c",
        # "src/hash/sha1dc/sha1.c",
        # "src/hash/sha1dc/ubc_check.c",
        "src/diff_print.c",
        "src/attr.c",
        "src/oidmap.c",
        "src/refdb_fs.c",
        "src/refs.c",
    ]

    thirdparty_sources = [thirdparty_dir + file for file in git2_sources]

    git2_include_paths = [
        'include/',
        'src/',
        'src/hash/',
        'deps/http-parser/',
        'deps/regex/',
        'deps/zlib/'
    ]
    git2_full_include_paths = [thirdparty_dir + file for file in git2_include_paths]

    env_git2.Prepend(CPPPATH=[git2_full_include_paths])
    env_git2.Prepend(CPPPATH=['#thirdparty/mbedtls/include'])
    env_git2.Append(CFLAGS=['-fPIC'])

    env_thirdparty = env_git2.Clone()
    env_thirdparty.disable_warnings()
    env_thirdparty.add_source_files(env.modules_sources, thirdparty_sources)

# Godot's own source files
env_git2.add_source_files(env.modules_sources, "*.cpp")
